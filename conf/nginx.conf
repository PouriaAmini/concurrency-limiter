daemon         off;

error_log /tmp/nginx_error.log warn;

events {
}

http {
    # Lua configuration
    lua_package_path    "$prefix/?.lua;;";
    lua_shared_dict     limit_conn_store    100M;
    lua_shared_dict     prometheus_metrics  10M;

    init_worker_by_lua_block {
        prometheus = require("prometheus").init("prometheus_metrics")
        metric_ifr = prometheus:gauge(
            "nginx_inflight_requests", "Number of in-flight requests");
    }

    server {
        listen 9145;
        location /metrics {
            content_by_lua_block {
                prometheus:collect()
            }
        }
    }

    server {
        listen 8000;
        location / {
            rewrite_by_lua_block {
                metric_ifr:inc(1)
            }
            proxy_pass http://localhost:8080;
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            log_by_lua_block {
                metric_ifr:inc(-1);
            }
        }
    }
}
